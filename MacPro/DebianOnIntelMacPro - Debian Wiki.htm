<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html><head>
<link rel="shortcut icon" href="https://wiki.debian.org/htdocs/favicon.ico">
<script type="text/javascript" src="DebianOnIntelMacPro%20-%20Debian%20Wiki_files/bugstatus.js"></script>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="robots" content="index,nofollow">

<title>DebianOnIntelMacPro - Debian Wiki</title>
<script type="text/javascript" src="DebianOnIntelMacPro%20-%20Debian%20Wiki_files/common.js"></script>

<script type="text/javascript">
<!--
var search_hint = "Search";
//-->
</script>


<link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="DebianOnIntelMacPro%20-%20Debian%20Wiki_files/common.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="screen" href="DebianOnIntelMacPro%20-%20Debian%20Wiki_files/screen.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="print" href="DebianOnIntelMacPro%20-%20Debian%20Wiki_files/print.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="projection" href="DebianOnIntelMacPro%20-%20Debian%20Wiki_files/projection.css">
<link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="DebianOnIntelMacPro%20-%20Debian%20Wiki_files/debian-wiki-1.css">

<!-- css only for MS IE6/IE7 browsers -->
<!--[if lt IE 8]>
   <link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="/htdocs/debwiki/css/msie.css">
<![endif]-->


<link rel="alternate" title="Debian Wiki: DebianOnIntelMacPro" href="https://wiki.debian.org/DebianOnIntelMacPro?diffs=1&amp;show_att=1&amp;action=rss_rc&amp;unique=0&amp;page=DebianOnIntelMacPro&amp;ddiffs=1" type="application/rss+xml">


<link rel="Start" href="https://wiki.debian.org/FrontPage">
<link rel="Alternate" title="Wiki Markup" href="https://wiki.debian.org/DebianOnIntelMacPro?action=raw">
<link rel="Alternate" media="print" title="Print View" href="https://wiki.debian.org/DebianOnIntelMacPro?action=print">
<link rel="Appendix" title="photo.png" href="https://wiki.debian.org/DebianOnIntelMacPro?action=AttachFile&amp;do=view&amp;target=photo.png">
<link rel="Appendix" title="smcfancontrol.c" href="https://wiki.debian.org/DebianOnIntelMacPro?action=AttachFile&amp;do=view&amp;target=smcfancontrol.c">
<link rel="Appendix" title="smcfancontrol.sh" href="https://wiki.debian.org/DebianOnIntelMacPro?action=AttachFile&amp;do=view&amp;target=smcfancontrol.sh">
<link rel="Search" href="https://wiki.debian.org/FindPage">
<link rel="Index" href="https://wiki.debian.org/TitleIndex">
<link rel="Glossary" href="https://wiki.debian.org/WordIndex">
<link rel="Help" href="https://wiki.debian.org/HelpOnFormatting">
</head>

<body dir="ltr" lang="en">
<div id="logo"><a href="https://www.debian.org/" title="Debian Homepage"><img src="DebianOnIntelMacPro%20-%20Debian%20Wiki_files/openlogo-50.png" alt="Debian" height="61" width="50"></a></div>
<div id="header">
<div id="wikisection">
<p class="section"><a href="https://wiki.debian.org/FrontPage" title="Debian Wiki Homepage">Wiki</a></p>
<div id="username"><a href="https://wiki.debian.org/DebianOnIntelMacPro?action=login" id="login" rel="nofollow">Login</a></div>
</div>
<div id="navbar">

<ul id="navibar">
<li class="wikilink"><a href="https://wiki.debian.org/FrontPage">FrontPage</a></li><li class="wikilink"><a href="https://wiki.debian.org/RecentChanges">RecentChanges</a></li><li class="wikilink"><a href="https://wiki.debian.org/FindPage">FindPage</a></li><li class="wikilink"><a href="https://wiki.debian.org/HelpContents">HelpContents</a></li><li class="current"><a href="https://wiki.debian.org/DebianOnIntelMacPro">DebianOnIntelMacPro</a></li>
</ul>

</div>

<form id="searchform" method="get" action="/DebianOnIntelMacPro">
<div>
<input name="action" value="fullsearch" type="hidden">
<input name="context" value="180" type="hidden">
<label for="searchinput" style="display: none;">Search:</label>
<input id="searchinput" name="value" value="Search" size="20" onfocus="searchFocus(this)" onblur="searchBlur(this)" onkeyup="searchChange(this)" onchange="searchChange(this)" alt="Search" type="text">
<input id="titlesearch" name="titlesearch" value="Titles" alt="Search Titles" type="submit">
<input id="fullsearch" name="fullsearch" value="Text" alt="Search Full Text" type="submit">
</div>
</form>
<script type="text/javascript">
<!--// Initialize search form
var f = document.getElementById('searchform');
f.getElementsByTagName('label')[0].style.display = 'none';
var e = document.getElementById('searchinput');
searchChange(e);
searchBlur(e);
//-->
</script>

<div id="logo"><a href="https://www.debian.org/" title="Debian Homepage"><img src="DebianOnIntelMacPro%20-%20Debian%20Wiki_files/openlogo-50.png" alt="Debian" height="61" width="50"></a></div>

<div id="breadcrumbs"><a href="https://wiki.debian.org/FrontPage" title="Debian Wiki Homepage">Wiki</a><span class="sep">/</span>

</div>

<ul class="editbar"><li><a href="https://wiki.debian.org/DebianOnIntelMacPro?action=login" id="login-1" rel="nofollow">Login</a></li><li class="toggleCommentsButton" style="display:none;"><a href="#" class="nbcomment" onclick="toggleComments();return false;">Comments</a></li><li><a class="nbinfo" href="https://wiki.debian.org/DebianOnIntelMacPro?action=info" rel="nofollow">Info</a></li><li><a class="nbattachments" href="https://wiki.debian.org/DebianOnIntelMacPro?action=AttachFile" rel="nofollow">Attachments</a></li><li>
<form class="actionsmenu" method="GET" action="/DebianOnIntelMacPro">
<div>
    
    <select name="action" onchange="if ((this.selectedIndex != 0) &amp;&amp;
                      (this.options[this.selectedIndex].disabled == false)) {
                this.form.submit();
            }
            this.selectedIndex = 0;">
        <option value="show" selected="selected">More Actions:</option><option value="raw">Raw Text</option>
<option value="print">Print View</option>
<option value="RenderAsDocbook">Render as Docbook</option>
<option value="refresh">Delete Cache</option>
<option value="show" disabled="disabled" class="disabled">------------------------</option>
<option value="SpellCheck">Check Spelling</option>
<option value="LikePages">Like Pages</option>
<option value="LocalSiteMap">Local Site Map</option>
<option value="show" disabled="disabled" class="disabled">------------------------</option>
<option value="RenamePage" disabled="disabled" class="disabled">Rename Page</option>
<option value="DeletePage" disabled="disabled" class="disabled">Delete Page</option>
<option value="show" disabled="disabled" class="disabled">------------------------</option>
<option value="show" disabled="disabled" class="disabled">Subscribe User</option>
<option value="show" disabled="disabled" class="disabled">------------------------</option>
<option value="show" disabled="disabled" class="disabled">Remove Spam</option>
<option value="show" disabled="disabled" class="disabled">Revert to this revision</option>
<option value="PackagePages">Package Pages</option>
<option value="show" disabled="disabled" class="disabled">------------------------</option>
<option value="Load">Load</option>
<option value="Save">Save</option>
<option value="SlideShow">SlideShow</option>
    </select>
    
    
</div>
<script type="text/javascript">
<!--// Init menu
actionsMenuInit('More Actions:');
//-->
</script>
</form>
</li></ul>

<h1 id="locationline">


<ul id="pagelocation">
<li><a href="https://wiki.debian.org/DebianOnIntelMacPro">DebianOnIntelMacPro</a></li>
</ul>

</h1>
</div>

<div id="page" dir="ltr" lang="en">
<div dir="ltr" id="content" lang="en"><span class="anchor" id="top"></span>
<span class="anchor" id="line-1"></span><div><table><tbody><tr>  <td><p class="line891"><img alt="photo.png" class="attachment" src="DebianOnIntelMacPro%20-%20Debian%20Wiki_files/DebianOnIntelMacPro.png" title="photo.png"></p></td>
  <td><p class="line862">By <a href="https://wiki.debian.org/RicardoYanez">RicardoYanez</a>.
 This page describes a method to install Debian on Apple Intel Mac Pro 
computers. It has been tested in two computer systems with a Quad-Core 
and dual Quad-core Xeon 5300-series "Clovertown" processors.</p></td>
</tr>
</tbody></table></div><span class="anchor" id="line-2"></span><span class="anchor" id="line-3"></span><p class="line862">(If
 you are trying to install onto anything other than the primary disk 
drive (i.e. the one that Mac OS X boots from), then read the "Booting 
from a second disk" section below (comments on that section to <a class="nonexistent" href="https://wiki.debian.org/MatthewVernon">?</a>MatthewVernon at his <a href="https://wiki.debian.org/Debian">Debian</a> address, please).) <span class="anchor" id="line-4"></span><span class="anchor" id="line-5"></span></p><p class="line874">If
 you have already tried to install Debian on Intel Mac Pro, you may have
 noticed the Debian Installer CD doesn't mount the CD-ROM properly. 
Eventually, no media is available to continue with the installation.  <span class="anchor" id="line-6"></span><span class="anchor" id="line-7"></span></p><p class="line874">For
 the inpatient, the next section explains how to install Debian with a 
custom Debian Installer mini CD and custom Linux kernel in few steps. <span class="anchor" id="line-8"></span><span class="anchor" id="line-9"></span></p><p class="line874">In the "Details" section I explain how I compiled the custom kernel and how I made the custom Debian Installer CD. <span class="anchor" id="line-10"></span><span class="anchor" id="line-11"></span></p><p class="line862">If you have a <a href="https://wiki.debian.org/MacBook">MacBook</a> Pro, you may want to see <a href="https://wiki.debian.org/MacBookPro">MacBookPro</a> instead. <span class="anchor" id="line-12"></span><span class="anchor" id="line-13"></span></p><p class="line867">
</p><h2 id="Debian_Installation">Debian Installation</h2>
<span class="anchor" id="line-14"></span><span class="anchor" id="line-15"></span><p class="line862">Download the <a class="http" href="http://apt.debianchile.org/macpro/mini.iso">Debian Installer Mini CD for Intel Mac Pro</a> (<tt class="backtick">MD5SUM&nbsp;023dadbea2bb5bc064d81b4fc62f184f</tt>), burn it to a CD, for example, <span class="anchor" id="line-16"></span><span class="anchor" id="line-17"></span></p><p class="line867"><span class="anchor" id="line-18"></span><span class="anchor" id="line-19"></span></p><pre><span class="anchor" id="line-1"></span>$ wodim -v -eject dev=/dev/cdrw -data mini.iso</pre><span class="anchor" id="line-20"></span><span class="anchor" id="line-21"></span><p class="line862">Being a mini CD, it contains no <tt class="backtick">.deb</tt> packages. You will need a network connection to install the base system. <span class="anchor" id="line-22"></span><span class="anchor" id="line-23"></span></p><p class="line862">Under Mac OS X, install <a class="http" href="http://refit.sourceforge.net/">rEFIt</a>, the EFI boot menu for Intel Mac. Easiest is to download the Mac disk image, double click on the icon and run the installer. <span class="anchor" id="line-24"></span><span class="anchor" id="line-25"></span></p><p class="line874">Still under Mac OS X, open the CD tray, insert the Debian Installer Mini CD and reboot. In the boot menu choose the penguin CD. <span class="anchor" id="line-26"></span><span class="anchor" id="line-27"></span></p><p class="line862">Boot the installer in <strong>expert</strong> mode. Install as you would in any system. <span class="anchor" id="line-28"></span><span class="anchor" id="line-29"></span></p><p class="line862">Choose to partition manually, then set the root partition <strong>bootable flag</strong> on. <span class="anchor" id="line-30"></span><span class="anchor" id="line-31"></span></p><p class="line862">During the installation of the base system, choose '<tt class="backtick">none</tt>' for the kernel to install. <span class="anchor" id="line-32"></span><span class="anchor" id="line-33"></span></p><p class="line874">Choose to continue without boot loader. <span class="anchor" id="line-34"></span><span class="anchor" id="line-35"></span></p><p class="line862">Just before finishing the installation, open a virtual terminal, <tt>&lt;ctrl&gt;-&lt;alt&gt;-&lt;f2&gt;</tt> for instance, and run a shell. Change the root directory with, <span class="anchor" id="line-36"></span><span class="anchor" id="line-37"></span></p><p class="line867"><span class="anchor" id="line-38"></span><span class="anchor" id="line-39"></span></p><pre><span class="anchor" id="line-1-1"></span># chroot /target</pre><span class="anchor" id="line-40"></span><span class="anchor" id="line-41"></span><p class="line862">Install <tt class="backtick">grub</tt> and <tt class="backtick">initramfs-tools</tt> with, <span class="anchor" id="line-42"></span><span class="anchor" id="line-43"></span></p><p class="line867"><span class="anchor" id="line-44"></span><span class="anchor" id="line-45"></span></p><pre><span class="anchor" id="line-1-2"></span># apt-get install grub initramfs-tools</pre><span class="anchor" id="line-46"></span><span class="anchor" id="line-47"></span><p class="line874">Run, <span class="anchor" id="line-48"></span><span class="anchor" id="line-49"></span><span class="anchor" id="line-50"></span></p><pre><span class="anchor" id="line-1-3"></span># grub-install /dev/sda</pre><span class="anchor" id="line-51"></span><span class="anchor" id="line-52"></span><p class="line874">to install GRUB on the first disk drive. <span class="anchor" id="line-53"></span><span class="anchor" id="line-54"></span></p><p class="line862">Edit <tt class="backtick">/etc/apt/sources.list</tt> and add line, <span class="anchor" id="line-55"></span><span class="anchor" id="line-56"></span></p><p class="line867"><span class="anchor" id="line-57"></span><span class="anchor" id="line-58"></span></p><pre><span class="anchor" id="line-1-4"></span> deb http://apt.debianchile.org/macpro etch main</pre><span class="anchor" id="line-59"></span><p class="line874">or <span class="anchor" id="line-60"></span><span class="anchor" id="line-61"></span><span class="anchor" id="line-62"></span></p><pre><span class="anchor" id="line-1-5"></span> deb http://apt.debianchile.org/macpro lenny main</pre><span class="anchor" id="line-63"></span><p class="line874">(untested) <span class="anchor" id="line-64"></span><span class="anchor" id="line-65"></span></p><p class="line874">You may want to install the archive key as well, <span class="anchor" id="line-66"></span><span class="anchor" id="line-67"></span><span class="anchor" id="line-68"></span><span class="anchor" id="line-69"></span></p><pre><span class="anchor" id="line-1-6"></span># gpg --keyserver hkp://pgp.mit.edu --recv-keys EFD17969
<span class="anchor" id="line-2"></span># gpg --export EFD17969 | apt-key add -</pre><span class="anchor" id="line-70"></span><span class="anchor" id="line-71"></span><p class="line862">Run '<tt class="backtick">apt-get&nbsp;update</tt>' and install the custom Etch kernel, <span class="anchor" id="line-72"></span><span class="anchor" id="line-73"></span></p><p class="line867"><span class="anchor" id="line-74"></span><span class="anchor" id="line-75"></span></p><pre><span class="anchor" id="line-1-7"></span># apt-get install linux-image-2.6.20-2-macpro-amd64</pre><span class="anchor" id="line-76"></span><p class="line874">or the custom Lenny kernel (untested), <span class="anchor" id="line-77"></span><span class="anchor" id="line-78"></span><span class="anchor" id="line-79"></span></p><pre><span class="anchor" id="line-1-8"></span># apt-get install linux-image-2.6.26-2-macpro-amd64</pre><span class="anchor" id="line-80"></span><span class="anchor" id="line-81"></span><p class="line874">Say no to abort kernel installation. <span class="anchor" id="line-82"></span><span class="anchor" id="line-83"></span></p><p class="line862">Run <tt>update-grub</tt> and create <tt>/boot/grub/menu.lst</tt>. <span class="anchor" id="line-84"></span><span class="anchor" id="line-85"></span></p><p class="line862">Go back to the installation terminal, <tt>&lt;ctrl&gt;-&lt;alt&gt;-&lt;f1&gt;</tt> and finish the installation. <span class="anchor" id="line-86"></span><span class="anchor" id="line-87"></span></p><p class="line874">In the boot menu choose the penguin disk. <span class="anchor" id="line-88"></span><span class="anchor" id="line-89"></span></p><p class="line874">After boot, you may want to install the kernel headers, <span class="anchor" id="line-90"></span><span class="anchor" id="line-91"></span></p><p class="line867"><span class="anchor" id="line-92"></span><span class="anchor" id="line-93"></span></p><pre><span class="anchor" id="line-1-9"></span># apt-get install linux-headers-2.6.20-2-macpro-amd64</pre><span class="anchor" id="line-94"></span><p class="line874">or <span class="anchor" id="line-95"></span><span class="anchor" id="line-96"></span><span class="anchor" id="line-97"></span></p><pre><span class="anchor" id="line-1-10"></span># apt-get install linux-headers-2.6.26-2-macpro-amd64</pre><span class="anchor" id="line-98"></span><span class="anchor" id="line-99"></span><p class="line862">If you like to make Debian the first boot device, under Mac OS X, edit <tt class="backtick">/efi/refit/refit.conf</tt> and uncomment option <tt class="backtick">legacyfirst</tt>. <span class="anchor" id="line-100"></span><span class="anchor" id="line-101"></span></p><p class="line874">If you feel uncomfortable using my custom kernel, compile your own using the mactel-linux patches as described below. <span class="anchor" id="line-102"></span><span class="anchor" id="line-103"></span></p><p class="line867">
</p><h2 id="Details">Details</h2>
<span class="anchor" id="line-104"></span><span class="anchor" id="line-105"></span><p class="line874">(This part requires some familiarity with kernel compilation and debian packaging). <span class="anchor" id="line-106"></span><span class="anchor" id="line-107"></span></p><p class="line874">I
 have two 64-bit dual Quad-Core Xeon E5335 "Clovertown" machines at 
work. One is an HP server, the other an Apple Intel Mac Pro. Both are 
primarily used to run and develop Monte Carlo simulations in parallel, 
or otherwise. <span class="anchor" id="line-108"></span><span class="anchor" id="line-109"></span></p><p class="line874">I
 obviously had no trouble installing Debian Etch on the HP server. On 
the Mac, the first thing one needs to do is to install rEFIt under Mac 
OS X, open the CD tray to insert the installation CD, boot and choose 
the penguin. <span class="anchor" id="line-110"></span><span class="anchor" id="line-111"></span></p><p class="line862">The
 Debian installer boots, but it doesn't mount the CD-ROM. Eventually, no
 media is available to continue with the base-system installation. I 
tried the standard approaches given in several wikies on the subject, 
e.g. boot parameters like '<tt>install&nbsp;noapic&nbsp;irqpoll&nbsp;acpi=force</tt>',
 and combinations thereof, but none really helped. I also tried a 
USB-key installation, only to learn Mac firmware doesn't support USB-key
 installations, at least in the machines I have. <span class="anchor" id="line-112"></span><span class="anchor" id="line-113"></span></p><p class="line874">Then
 a co-worker handed me an Ubuntu 7.04 Feisty server installation CD, 
which recognized the CD-ROM, mounted the CD, installed the base system, 
and went all the way to the finish line. After boot, the kernel would 
not load, though. I read several guides describing some very intricate 
recipes, which included the need of Live CDs and disk partition 
utilities. None of these approaches is really necessary, once you 
realize the only thing they are trying to do is to set the boot flag on 
the root partition. <span class="anchor" id="line-114"></span><span class="anchor" id="line-115"></span></p><p class="line874">This
 exercise made me realize the installer needs to attach the CD-ROM not 
as ATAPI IDE (ide-cd) as the Debian Installer does, but under SATA (not 
sure here why, nor if this statement is absolutely true.) <span class="anchor" id="line-116"></span><span class="anchor" id="line-117"></span></p><p class="line874">My
 plan of action was then to compile a custom kernel a la Ubuntu (which 
has the Mactel-linux patches included) that attaches the CD-ROM as the 
hardware requires, then make a new Debian Installer CD with it. <span class="anchor" id="line-118"></span><span class="anchor" id="line-119"></span></p><p class="line862">I followed closely <a href="https://wiki.debian.org/DebianInstaller/Modify/CustomKernel">DebianInstaller/Modify/CustomKernel</a> and <a href="https://wiki.debian.org/DebianInstaller/BuildEtch">DebianInstaller/BuildEtch</a>. <span class="anchor" id="line-120"></span><span class="anchor" id="line-121"></span></p><p class="line874">In
 short, kernel 2.6.20 is compiled with the mactel-linux patches, then 
debian-installer is used to create the mini installation image. <span class="anchor" id="line-122"></span><span class="anchor" id="line-123"></span></p><p class="line867">
</p><h3 id="Custom_kernel_2.6">Custom kernel 2.6</h3>
<span class="anchor" id="line-124"></span><span class="anchor" id="line-125"></span><p class="line862">I
 compiled the kernel in the HP server running Debian Etch. I used kernel
 version 2.6.20, downloaded from kernel.org. Untar the tarball in <tt>/usr/src</tt>. <span class="anchor" id="line-126"></span><span class="anchor" id="line-127"></span></p><p class="line862">Install <tt class="backtick">subversion</tt> and get the mactel-linux kernel patches, <span class="anchor" id="line-128"></span><span class="anchor" id="line-129"></span></p><p class="line867"><span class="anchor" id="line-130"></span><span class="anchor" id="line-131"></span></p><pre><span class="anchor" id="line-1-11"></span># svn co https://mactel-linux.svn.sourceforge.net/svnroot/mactel-linux mactel-linux</pre><span class="anchor" id="line-132"></span><span class="anchor" id="line-133"></span><p class="line862">Go to <tt class="backtick">trunk/kernel/mactel-patches-[kernel-version]</tt> and apply patches with, <span class="anchor" id="line-134"></span><span class="anchor" id="line-135"></span></p><p class="line867"><span class="anchor" id="line-136"></span><span class="anchor" id="line-137"></span></p><pre><span class="anchor" id="line-1-12"></span># ./apply /usr/src/[linux-source-directory]</pre><span class="anchor" id="line-138"></span><span class="anchor" id="line-139"></span><p class="line862">Install <tt class="backtick">kernel-package</tt> and <tt class="backtick">libncurses5-dev</tt>. Go the the kernel source directory and '<tt class="backtick">make&nbsp;menuconfig</tt>'. <span class="anchor" id="line-140"></span><span class="anchor" id="line-141"></span></p><p class="line862">This is the current <a class="http" href="http://apt.debianchile.org/macpro/config-2.6.20-2-macpro-amd64">.config</a> file. <span class="anchor" id="line-142"></span><span class="anchor" id="line-143"></span></p><p class="line862">Before compiling, edit <tt class="backtick">Makefile</tt> and remove the <tt class="backtick">EXTRAVERSION</tt> introduced by the Mactel-linux patching. Leave it blank. <span class="anchor" id="line-144"></span><span class="anchor" id="line-145"></span></p><p class="line874">Compile with, <span class="anchor" id="line-146"></span><span class="anchor" id="line-147"></span></p><p class="line867"><span class="anchor" id="line-148"></span><span class="anchor" id="line-149"></span></p><pre><span class="anchor" id="line-1-13"></span># make-kpkg --initrd --append-to-version=-1-macpro-amd64 --revision=2.6.20 kernel_image kernel_headers</pre><span class="anchor" id="line-150"></span><span class="anchor" id="line-151"></span><p class="line874">Install the custom kernel. No need to boot it in what follows. <span class="anchor" id="line-152"></span><span class="anchor" id="line-153"></span></p><p class="line867">
</p><h3 id="Kernel_udebs">Kernel udebs</h3>
<span class="anchor" id="line-154"></span><span class="anchor" id="line-155"></span><p class="line862">I'm repeating here some, if not most, of <a href="https://wiki.debian.org/DebianInstaller/Modify/CustomKernel">DebianInstaller/Modify/CustomKernel</a>. <span class="anchor" id="line-156"></span><span class="anchor" id="line-157"></span></p><p class="line862">Install <tt class="backtick">devscripts</tt> and <tt class="backtick">kernel-wedge</tt>. <span class="anchor" id="line-158"></span><span class="anchor" id="line-159"></span></p><p class="line862">Unpack the source package <tt class="backtick">linux-kernel-di-amd64-2.6</tt>, <span class="anchor" id="line-160"></span><span class="anchor" id="line-161"></span></p><p class="line867"><span class="anchor" id="line-162"></span><span class="anchor" id="line-163"></span></p><pre><span class="anchor" id="line-1-14"></span># apt-get source linux-kernel-di-amd64-2.6</pre><span class="anchor" id="line-164"></span><span class="anchor" id="line-165"></span><p class="line862">Go to the directory and edit <tt class="backtick">kernel-versions</tt> to match the new version, <tt class="backtick">2.6.20-1-macpro-amd64</tt>. Comment out or delete the existing line. <span class="anchor" id="line-166"></span><span class="anchor" id="line-167"></span></p><p class="line862">Check for build dependencies with <tt class="backtick">dpkg-checkbuilddeps</tt>, and install dependencies as needed. <span class="anchor" id="line-168"></span><span class="anchor" id="line-169"></span></p><p class="line862">If you have a GPG signature you can do '<tt class="backtick">debchange&nbsp;-i</tt>'
 to edit the changelog with your e-mail address and some comments. The 
directory name will change, reflecting the new version number. You will 
have to go to the parent directory, then back into the new directory. 
You may also want to change the <tt class="backtick">Maintainer:</tt> field in <tt class="backtick">debian/control.stub</tt>, and define the <tt class="backtick">EMAIL</tt> and <tt class="backtick">GNUPGHOME</tt> environment variables in the user's <tt class="backtick">.bashrc</tt>, then source it. <span class="anchor" id="line-170"></span><span class="anchor" id="line-171"></span></p><p class="line862">Build the package with <tt class="backtick">debuild</tt>, or '<tt class="backtick">debuild&nbsp;-rfakeroot</tt>' if not root. <span class="anchor" id="line-172"></span><span class="anchor" id="line-173"></span></p><p class="line862">If you have no GPG signature, build with '<tt class="backtick">debuild&nbsp;binary</tt>', or '<tt class="backtick">debuild&nbsp;-rfakeroot&nbsp;binary</tt>' if not root instead. <span class="anchor" id="line-174"></span><span class="anchor" id="line-175"></span></p><p class="line862">The building may fail due to missing kernel modules. Edit module listings in <tt class="backtick">modules/amd64</tt> needed be. I copied some of the include files into the directory and put a <tt class="backtick">?</tt>
 at the end of the missing module. See kernel-wedge documentation for 
more options. I had to delete some module-list files that generated 
empty udebs. <span class="anchor" id="line-176"></span><span class="anchor" id="line-177"></span></p><p class="line874">If you have a GPG signature, sign the files. <span class="anchor" id="line-178"></span><span class="anchor" id="line-179"></span></p><p class="line874">You should end up with a bunch of udebs in the parent directory. <span class="anchor" id="line-180"></span><span class="anchor" id="line-181"></span></p><p class="line867">
</p><h3 id="Debian_Installer">Debian Installer</h3>
<span class="anchor" id="line-182"></span><span class="anchor" id="line-183"></span><p class="line874">Get the source, <span class="anchor" id="line-184"></span><span class="anchor" id="line-185"></span></p><p class="line867"><span class="anchor" id="line-186"></span><span class="anchor" id="line-187"></span></p><pre><span class="anchor" id="line-1-15"></span># apt-get source debian-installer</pre><span class="anchor" id="line-188"></span><span class="anchor" id="line-189"></span><p class="line874">Go to directory and check for dependencies. <span class="anchor" id="line-190"></span><span class="anchor" id="line-191"></span></p><p class="line862">Edit <tt class="backtick">build/config/amd64.cfg</tt> and change <tt class="backtick">KERNELVERSION</tt>. Uncomment monolithic image type. <span class="anchor" id="line-192"></span><span class="anchor" id="line-193"></span></p><p class="line862">Copy all kernel udebs into <tt class="backtick">build/localudebs</tt>. <span class="anchor" id="line-194"></span><span class="anchor" id="line-195"></span></p><p class="line862">Go to <tt class="backtick">build/</tt> and build the monolithic image, <span class="anchor" id="line-196"></span><span class="anchor" id="line-197"></span></p><p class="line867"><span class="anchor" id="line-198"></span><span class="anchor" id="line-199"></span></p><pre><span class="anchor" id="line-1-16"></span># make build_monolithic</pre><span class="anchor" id="line-200"></span><span class="anchor" id="line-201"></span><p class="line862">The image is placed in <tt class="backtick">dest/monolithic</tt>. <span class="anchor" id="line-202"></span><span class="anchor" id="line-203"></span></p><p class="line874">Now you have the CD image and the kernel image. Install as described in the installation section. <span class="anchor" id="line-204"></span><span class="anchor" id="line-205"></span></p><p class="line867">
</p><h2 id="Booting_from_a_second_disk">Booting from a second disk</h2>
<span class="anchor" id="line-206"></span><span class="anchor" id="line-207"></span><p class="line862">By <a class="nonexistent" href="https://wiki.debian.org/MatthewVernon">?</a>MatthewVernon <span class="anchor" id="line-208"></span><span class="anchor" id="line-209"></span></p><p class="line862">rEFIt
 assumes that you have only one disk drive. If you try and install linux
 onto a secondary drive, you will probably have found that rEFIt lets 
you try and boot your newly-minted linux partition/drive, only for you 
to get a "Missing operating system" error message. This is actually a <a class="http" href="http://syslinux.zytor.com/">Syslinux</a>
 error message. What happens is that rEFIt looks on the primary disk for
 an MBR record, fails to find one (obviously!), so sticks the syslinux 
MBR onto the primary disk, and tries to boot that. You can confirm that 
this has happened, with some runes like the following: <span class="anchor" id="line-210"></span><span class="anchor" id="line-211"></span></p><p class="line867"><span class="anchor" id="line-212"></span><span class="anchor" id="line-213"></span><span class="anchor" id="line-214"></span></p><pre><span class="anchor" id="line-1-17"></span># dd if=/dev/sda of=/tmp/mbr bs=512 count=1
<span class="anchor" id="line-2-1"></span># file /tmp/mbr</pre><span class="anchor" id="line-215"></span><span class="anchor" id="line-216"></span><p class="line862">Hopefully
 this rEFIt bug will be fixed, but in the mean-time, the best 
work-around is to install GRUB or LILO onto the MBR of the primary 
hard-disk, and use that to boot your partition. This means you'll end up
 having to select linux at the rEFIt menu, and then again in the GRUB or
 LILO menu, but you can always turn the timeout down very low in LILO <img alt=";-)" src="DebianOnIntelMacPro%20-%20Debian%20Wiki_files/smile4.png" title=";-)" height="16" width="16"> Something like this in <tt class="backtick">lilo.conf</tt>: <span class="anchor" id="line-217"></span><span class="anchor" id="line-218"></span></p><p class="line867"><span class="anchor" id="line-219"></span><span class="anchor" id="line-220"></span><span class="anchor" id="line-221"></span><span class="anchor" id="line-222"></span><span class="anchor" id="line-223"></span><span class="anchor" id="line-224"></span><span class="anchor" id="line-225"></span></p><pre><span class="anchor" id="line-1-18"></span>boot=/dev/sda
<span class="anchor" id="line-2-2"></span>root=/dev/sdb2
<span class="anchor" id="line-3"></span>image=/boot/vmlinuz-2.6.20-2-macpro-amd64
<span class="anchor" id="line-4"></span>        label="Lin 2.6.20img0"
<span class="anchor" id="line-5"></span>        initrd=/boot/initrd.img-2.6.20-2-macpro-amd64
<span class="anchor" id="line-6"></span>        read-only</pre><span class="anchor" id="line-226"></span><span class="anchor" id="line-227"></span><p class="line874">Should do the trick. <span class="anchor" id="line-228"></span><span class="anchor" id="line-229"></span></p><p class="line867">
</p><h2 id="Fan_speed_control">Fan speed control</h2>
<span class="anchor" id="line-230"></span><span class="anchor" id="line-231"></span><p class="line862">By <a class="nonexistent" href="https://wiki.debian.org/AlexeyAnikeenko">?</a>AlexeyAnikeenko <span class="anchor" id="line-232"></span><span class="anchor" id="line-233"></span></p><p class="line874">If your Mac Pro does not change the fan speeds automatically, it can lead to overheating under heavy loads. <span class="anchor" id="line-234"></span>This
 daemon monitors current core temperatures and sets minimal rotation 
speed for fans under control. You should check MIN/MAX values and 
temperature_to_speed_step() function before use. <span class="anchor" id="line-235"></span><span class="anchor" id="line-236"></span></p><p class="line867"><span class="anchor" id="line-1-1"></span></p><div class="highlight text"><div class="codearea" dir="ltr" lang="en">
<script type="text/javascript">
function isnumbered(obj) {
  return obj.childNodes.length && obj.firstChild.childNodes.length && obj.firstChild.firstChild.className == 'LineNumber';
}
function nformat(num,chrs,add) {
  var nlen = Math.max(0,chrs-(''+num).length), res = '';
  while (nlen>0) { res += ' '; nlen-- }
  return res+num+add;
}
function addnumber(did, nstart, nstep) {
  var c = document.getElementById(did), l = c.firstChild, n = 1;
  if (!isnumbered(c)) {
    if (typeof nstart == 'undefined') nstart = 1;
    if (typeof nstep  == 'undefined') nstep = 1;
    var n = nstart;
    while (l != null) {
      if (l.tagName == 'SPAN') {
        var s = document.createElement('SPAN');
        var a = document.createElement('A');
        s.className = 'LineNumber';
        a.appendChild(document.createTextNode(nformat(n,4,'')));
        a.href = '#' + did + '_' + n;
        s.appendChild(a);
        s.appendChild(document.createTextNode(' '));
        n += nstep;
        if (l.childNodes.length) {
          l.insertBefore(s, l.firstChild);
        }
        else {
          l.appendChild(s);
        }
      }
      l = l.nextSibling;
    }
  }
  return false;
}
function remnumber(did) {
  var c = document.getElementById(did), l = c.firstChild;
  if (isnumbered(c)) {
    while (l != null) {
      if (l.tagName == 'SPAN' && l.firstChild.className == 'LineNumber') l.removeChild(l.firstChild);
      l = l.nextSibling;
    }
  }
  return false;
}
function togglenumber(did, nstart, nstep) {
  var c = document.getElementById(did);
  if (isnumbered(c)) {
    remnumber(did);
  } else {
    addnumber(did,nstart,nstep);
  }
  return false;
}
</script>

<script type="text/javascript">
document.write('<a href="#" onclick="return togglenumber(\'CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7\', 1, 1);" \
                class="codenumbers">Toggle line numbers<\/a>');
</script><a href="#" onclick="return togglenumber('CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7', 1, 1);" class="codenumbers">Toggle line numbers</a>
<pre dir="ltr" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7" lang="en"><span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_1">   1</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_1"></span><span class="anchor" id="line-1-2"></span><span class="Comment">/*</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_2">   2</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_2"></span><span class="anchor" id="line-2-1"></span><span class="Comment"> *  smcfancontrol.c : fan control daemon for Apple Intel Mac Pro </span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_3">   3</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_3"></span><span class="anchor" id="line-3-1"></span><span class="Comment"> *  based on cmp-daemon 0.21 from http://aur.archlinux.org/packages.php?ID=21391</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_4">   4</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_4"></span><span class="anchor" id="line-4-1"></span><span class="Comment"> *</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_5">   5</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_5"></span><span class="anchor" id="line-5-1"></span><span class="Comment"> *  Copyright (C) 2009 Alexey Anikeenko</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_6">   6</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_6"></span><span class="anchor" id="line-6-1"></span><span class="Comment"> *</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_7">   7</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_7"></span><span class="anchor" id="line-7-1"></span><span class="Comment"> *  This program is free software; you can redistribute it and/or modify</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_8">   8</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_8"></span><span class="anchor" id="line-8-1"></span><span class="Comment"> *  it under the terms of the GNU General Public License as published by</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_9">   9</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_9"></span><span class="anchor" id="line-9-1"></span><span class="Comment"> *  the Free Software Foundation; either version 2 of the License, or</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_10">  10</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_10"></span><span class="anchor" id="line-10-1"></span><span class="Comment"> *  (at your option) any later version.</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_11">  11</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_11"></span><span class="anchor" id="line-11-1"></span><span class="Comment"> *</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_12">  12</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_12"></span><span class="anchor" id="line-12-1"></span><span class="Comment"> *  This program is distributed in the hope that it will be useful, </span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_13">  13</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_13"></span><span class="anchor" id="line-13-1"></span><span class="Comment"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_14">  14</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_14"></span><span class="anchor" id="line-14-1"></span><span class="Comment"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_15">  15</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_15"></span><span class="anchor" id="line-15-1"></span><span class="Comment"> *  GNU General Public License for more details.</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_16">  16</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_16"></span><span class="anchor" id="line-16-1"></span><span class="Comment"> *</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_17">  17</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_17"></span><span class="anchor" id="line-17-1"></span><span class="Comment"> *  You should have received a copy of the GNU General Public License</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_18">  18</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_18"></span><span class="anchor" id="line-18-1"></span><span class="Comment"> *  along with this program; if not, write to the Free Software</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_19">  19</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_19"></span><span class="anchor" id="line-19-1"></span><span class="Comment"> *  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_20">  20</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_20"></span><span class="anchor" id="line-20-1"></span><span class="Comment"> */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_21">  21</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_21"></span><span class="anchor" id="line-21-1"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_22">  22</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_22"></span><span class="anchor" id="line-22-1"></span><span class="Preprc">#</span><span class="Preprc">include &lt;stdio.h&gt;</span><span class="Preprc"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_23">  23</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_23"></span><span class="anchor" id="line-23-1"></span><span class="Preprc"></span><span class="Preprc">#</span><span class="Preprc">include &lt;stdlib.h&gt;</span><span class="Preprc"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_24">  24</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_24"></span><span class="anchor" id="line-24-1"></span><span class="Preprc"></span><span class="Preprc">#</span><span class="Preprc">include &lt;unistd.h&gt;</span><span class="Preprc"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_25">  25</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_25"></span><span class="anchor" id="line-25-1"></span><span class="Preprc"></span><span class="Preprc">#</span><span class="Preprc">include &lt;sys</span><span class="Preprc">/</span><span class="Preprc">types.h&gt;</span><span class="Preprc"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_26">  26</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_26"></span><span class="anchor" id="line-26-1"></span><span class="Preprc"></span><span class="Preprc">#</span><span class="Preprc">include &lt;sys</span><span class="Preprc">/</span><span class="Preprc">stat.h&gt;</span><span class="Preprc"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_27">  27</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_27"></span><span class="anchor" id="line-27-1"></span><span class="Preprc"></span><span class="Preprc">#</span><span class="Preprc">include &lt;errno.h&gt;</span><span class="Preprc"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_28">  28</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_28"></span><span class="anchor" id="line-28-1"></span><span class="Preprc"></span><span class="Preprc">#</span><span class="Preprc">include &lt;fcntl.h&gt;</span><span class="Preprc"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_29">  29</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_29"></span><span class="anchor" id="line-29-1"></span><span class="Preprc"></span><span class="Preprc">#</span><span class="Preprc">include &lt;time.h&gt;</span><span class="Preprc"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_30">  30</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_30"></span><span class="anchor" id="line-30-1"></span><span class="Preprc"></span><span class="Preprc">#</span><span class="Preprc">include &lt;signal.h&gt;</span><span class="Preprc"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_31">  31</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_31"></span><span class="anchor" id="line-31-1"></span><span class="Preprc"></span><span class="Preprc">#</span><span class="Preprc">include &lt;string.h&gt;</span><span class="Preprc"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_32">  32</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_32"></span><span class="anchor" id="line-32-1"></span><span class="Preprc"></span><span class="Preprc">#</span><span class="Preprc">include &lt;syslog.h&gt;</span><span class="Preprc"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_33">  33</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_33"></span><span class="anchor" id="line-33-1"></span><span class="Preprc"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_34">  34</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_34"></span><span class="anchor" id="line-34-1"></span><span class="Preprc">#</span><span class="Preprc">define SYSFS_PATH_MAX 256</span><span class="Preprc"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_35">  35</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_35"></span><span class="anchor" id="line-35-1"></span><span class="Preprc"></span><span class="Preprc">#</span><span class="Preprc">define SPEED_STEP_MAX 20</span><span class="Preprc"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_36">  36</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_36"></span><span class="anchor" id="line-36-1"></span><span class="Preprc"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_37">  37</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_37"></span><span class="anchor" id="line-37-1"></span><span class="ResWord">static</span> <span class="ResWord">const</span> <span class="ResWord">char</span> *<span class="ID">PIDFILE</span> = <span class="String">"</span><span class="String">/var/run/smcfancontrol.pid</span><span class="String">"</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_38">  38</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_38"></span><span class="anchor" id="line-38-1"></span><span class="ResWord">static</span> <span class="ResWord">const</span> <span class="ResWord">char</span> *<span class="ID">SMCDIR</span> = <span class="String">"</span><span class="String">/sys/devices/platform/applesmc.768</span><span class="String">"</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_39">  39</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_39"></span><span class="anchor" id="line-39-1"></span><span class="ResWord">static</span> <span class="ResWord">const</span> <span class="ResWord">char</span> *<span class="ID">CORETEMP_PREFIX</span> = <span class="String">"</span><span class="String">/sys/devices/platform/coretemp</span><span class="String">"</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_40">  40</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_40"></span><span class="anchor" id="line-40-1"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_41">  41</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_41"></span><span class="anchor" id="line-41-1"></span><span class="ResWord">static</span> <span class="ResWord">const</span> <span class="ResWord">struct</span> <span class="ID">timespec</span> <span class="ID">smc_write_delay</span> = { <span class="Number">0</span>, <span class="Number">5000000</span> }; <span class="Comment">/* 5 ms delay between writes to smc controller */</span> </span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_42">  42</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_42"></span><span class="anchor" id="line-42-1"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_43">  43</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_43"></span><span class="anchor" id="line-43-1"></span><span class="Comment">/* Reference data for dual-Xeon_X5482 Mac Pro:</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_44">  44</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_44"></span><span class="anchor" id="line-44-1"></span><span class="Comment">const int FANS_EFI_MIN[] = { 500, 800, 600, 600 };</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_45">  45</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_45"></span><span class="anchor" id="line-45-1"></span><span class="Comment">const int FANS_EFI_MAX[] = { 2900, 2900, 2900, 2800 };</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_46">  46</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_46"></span><span class="anchor" id="line-46-1"></span><span class="Comment">const char *FANS_LABEL[] = { "CPU_MEM", "IO", "EXHAUST", "PS" };</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_47">  47</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_47"></span><span class="anchor" id="line-47-1"></span><span class="Comment">*/</span> </span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_48">  48</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_48"></span><span class="anchor" id="line-48-1"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_49">  49</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_49"></span><span class="anchor" id="line-49-1"></span><span class="ResWord">const</span> <span class="ResWord">int</span> <span class="ID">FANS</span>[] = { <span class="Number">1</span>, <span class="Number">2</span>, <span class="Number">3</span> };  <span class="Comment">/* suffixes of fans under control */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_50">  50</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_50"></span><span class="anchor" id="line-50-1"></span><span class="ResWord">const</span> <span class="ResWord">int</span> <span class="ID">FANS_MIN</span>[] = { <span class="Number">800</span>, <span class="Number">800</span>, <span class="Number">600</span> };</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_51">  51</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_51"></span><span class="anchor" id="line-51-1"></span><span class="ResWord">const</span> <span class="ResWord">int</span> <span class="ID">FANS_MAX</span>[] = { <span class="Number">2200</span>, <span class="Number">2200</span>, <span class="Number">2200</span> };</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_52">  52</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_52"></span><span class="anchor" id="line-52-1"></span><span class="ResWord">const</span> <span class="ResWord">int</span> <span class="ID">FANS_NUM</span> = <span class="ResWord">sizeof</span>(<span class="ID">FANS</span>)/<span class="ResWord">sizeof</span>(<span class="ID">FANS</span>[<span class="Number">0</span>]);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_53">  53</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_53"></span><span class="anchor" id="line-53-1"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_54">  54</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_54"></span><span class="anchor" id="line-54-1"></span><span class="ResWord">const</span> <span class="ResWord">int</span> <span class="ID">SENSORS</span>[] = { <span class="Number">0</span>, <span class="Number">1</span>, <span class="Number">2</span>, <span class="Number">3</span>, <span class="Number">4</span>, <span class="Number">5</span>, <span class="Number">6</span>, <span class="Number">7</span> };  <span class="Comment">/* suffixes of used coretemp sensors */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_55">  55</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_55"></span><span class="anchor" id="line-55-1"></span><span class="ResWord">const</span> <span class="ResWord">int</span> <span class="ID">SENSORS_NUM</span> = <span class="ResWord">sizeof</span>(<span class="ID">SENSORS</span>)/<span class="ResWord">sizeof</span>(<span class="ID">SENSORS</span>[<span class="Number">0</span>]);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_56">  56</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_56"></span><span class="anchor" id="line-56-1"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_57">  57</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_57"></span><span class="anchor" id="line-57-1"></span><span class="ResWord">static</span> <span class="ResWord">int</span> <span class="ID">get_sensors_temp</span>(<span class="ResWord">void</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_58">  58</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_58"></span><span class="anchor" id="line-58-1"></span><span class="ResWord">static</span> <span class="ResWord">void</span> <span class="ID">set_fans_manual</span>(<span class="ResWord">int</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_59">  59</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_59"></span><span class="anchor" id="line-59-1"></span><span class="ResWord">static</span> <span class="ResWord">void</span> <span class="ID">set_fans_min</span>(<span class="ResWord">int</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_60">  60</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_60"></span><span class="anchor" id="line-60-1"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_61">  61</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_61"></span><span class="anchor" id="line-61-1"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_62">  62</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_62"></span><span class="anchor" id="line-62-1"></span><span class="Comment">/*</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_63">  63</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_63"></span><span class="anchor" id="line-63-1"></span><span class="Comment"> * Fan speed depends linearly on the speed step and changes </span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_64">  64</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_64"></span><span class="anchor" id="line-64-1"></span><span class="Comment"> * between FAN_MIN and FAN_MAX for steps in range [0, SPEED_STEP_MAX]. </span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_65">  65</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_65"></span><span class="anchor" id="line-65-1"></span><span class="Comment"> * This function converts current temperature to speed step </span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_66">  66</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_66"></span><span class="anchor" id="line-66-1"></span><span class="Comment"> * and should be calibrated for your box! </span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_67">  67</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_67"></span><span class="anchor" id="line-67-1"></span><span class="Comment"> */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_68">  68</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_68"></span><span class="anchor" id="line-68-1"></span><span class="ResWord">int</span> <span class="ID">temperature_to_speed_step</span>(<span class="ResWord">int</span> <span class="ID">t</span>)</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_69">  69</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_69"></span><span class="anchor" id="line-69-1"></span>{</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_70">  70</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_70"></span><span class="anchor" id="line-70-1"></span>    <span class="ResWord">int</span> <span class="ID">step</span> = ((<span class="ID">t</span>-<span class="Number">45</span>)*<span class="ID">SPEED_STEP_MAX</span>)/(<span class="Number">75</span>-<span class="Number">45</span>);  </span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_71">  71</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_71"></span><span class="anchor" id="line-71-1"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_72">  72</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_72"></span><span class="anchor" id="line-72-1"></span>    <span class="ResWord">if</span> (<span class="ID">step</span> &lt; <span class="Number">0</span> ) <span class="ID">step</span> = <span class="Number">0</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_73">  73</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_73"></span><span class="anchor" id="line-73-1"></span>    <span class="ResWord">if</span> (<span class="ID">step</span> &gt; <span class="ID">SPEED_STEP_MAX</span> ) <span class="ID">step</span> = <span class="ID">SPEED_STEP_MAX</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_74">  74</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_74"></span><span class="anchor" id="line-74-1"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_75">  75</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_75"></span><span class="anchor" id="line-75-1"></span>    <span class="ResWord">return</span> <span class="ID">step</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_76">  76</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_76"></span><span class="anchor" id="line-76-1"></span>}</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_77">  77</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_77"></span><span class="anchor" id="line-77-1"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_78">  78</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_78"></span><span class="anchor" id="line-78-1"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_79">  79</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_79"></span><span class="anchor" id="line-79-1"></span><span class="Comment">/* clean up and exit */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_80">  80</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_80"></span><span class="anchor" id="line-80-1"></span><span class="ResWord">static</span> <span class="ResWord">void</span> <span class="ID">clean_exit_with_status</span>(<span class="ResWord">int</span> <span class="ID">status</span>)</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_81">  81</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_81"></span><span class="anchor" id="line-81-1"></span>{</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_82">  82</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_82"></span><span class="anchor" id="line-82-1"></span>    <span class="ID">set_fans_manual</span>(<span class="Number">0</span>); <span class="Comment">/* set fans to automatic control */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_83">  83</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_83"></span><span class="anchor" id="line-83-1"></span>    <span class="ID">syslog</span>(<span class="ID">LOG_NOTICE</span>, <span class="String">"</span><span class="String">exiting</span><span class="SPChar">\n</span><span class="String">"</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_84">  84</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_84"></span><span class="anchor" id="line-84-1"></span>    <span class="ID">unlink</span>(<span class="ID">PIDFILE</span>);    <span class="Comment">/* remove pidfile */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_85">  85</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_85"></span><span class="anchor" id="line-85-1"></span>    <span class="ID">exit</span>(<span class="ID">status</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_86">  86</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_86"></span><span class="anchor" id="line-86-1"></span>}</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_87">  87</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_87"></span><span class="anchor" id="line-87-1"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_88">  88</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_88"></span><span class="anchor" id="line-88-1"></span><span class="Comment">/* signal handler for clean exit */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_89">  89</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_89"></span><span class="anchor" id="line-89-1"></span><span class="ResWord">static</span> <span class="ResWord">void</span> <span class="ID">clean_exit</span>(<span class="ResWord">int</span> <span class="ID">sig</span> <span class="ID">__attribute__</span>((<span class="ID">unused</span>)))</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_90">  90</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_90"></span><span class="anchor" id="line-90-1"></span>{</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_91">  91</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_91"></span><span class="anchor" id="line-91-1"></span>    <span class="ID">clean_exit_with_status</span>(<span class="ID">EXIT_SUCCESS</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_92">  92</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_92"></span><span class="anchor" id="line-92-1"></span>}</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_93">  93</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_93"></span><span class="anchor" id="line-93-1"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_94">  94</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_94"></span><span class="anchor" id="line-94-1"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_95">  95</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_95"></span><span class="anchor" id="line-95-1"></span><span class="Comment">/* set fanX_min (min rotation speed) according to current speed step */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_96">  96</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_96"></span><span class="anchor" id="line-96-1"></span><span class="ResWord">static</span> <span class="ResWord">void</span> <span class="ID">set_fans_min</span>(<span class="ResWord">int</span> <span class="ID">speed_step</span>)</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_97">  97</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_97"></span><span class="anchor" id="line-97-1"></span>{</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_98">  98</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_98"></span><span class="anchor" id="line-98-1"></span>    <span class="ResWord">int</span> <span class="ID">i</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_99">  99</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_99"></span><span class="anchor" id="line-99-1"></span>    <span class="ResWord">FILE</span> *<span class="ID">file</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_100"> 100</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_100"></span><span class="anchor" id="line-100-1"></span>    <span class="ResWord">char</span> <span class="ID">fan_path</span>[<span class="ID">SYSFS_PATH_MAX</span>];</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_101"> 101</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_101"></span><span class="anchor" id="line-101-1"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_102"> 102</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_102"></span><span class="anchor" id="line-102-1"></span>    <span class="Comment">/* for fans under control write rpm to fanX_min */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_103"> 103</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_103"></span><span class="anchor" id="line-103-1"></span>    <span class="ResWord">for</span>(<span class="ID">i</span>=<span class="Number">0</span>; <span class="ID">i</span> &lt; <span class="ID">FANS_NUM</span>; <span class="ID">i</span>++ )</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_104"> 104</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_104"></span><span class="anchor" id="line-104-1"></span>    {</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_105"> 105</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_105"></span><span class="anchor" id="line-105-1"></span>        <span class="Comment">/* fan speed depends linearly on the speed step and changes </span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_106"> 106</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_106"></span><span class="anchor" id="line-106-1"></span><span class="Comment">         * between FAN_MIN and FAN_MAX for steps in range [0, SPEED_STEP_MAX] */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_107"> 107</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_107"></span><span class="anchor" id="line-107-1"></span>        <span class="ResWord">int</span> <span class="ID">speed</span> = <span class="ID">FANS_MIN</span>[<span class="ID">i</span>] + <span class="ID">speed_step</span>*(<span class="ID">FANS_MAX</span>[<span class="ID">i</span>]-<span class="ID">FANS_MIN</span>[<span class="ID">i</span>])/<span class="ID">SPEED_STEP_MAX</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_108"> 108</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_108"></span><span class="anchor" id="line-108-1"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_109"> 109</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_109"></span><span class="anchor" id="line-109-1"></span>        <span class="ID">sprintf</span>(<span class="ID">fan_path</span>, <span class="String">"</span><span class="String">%s/fan%d_min</span><span class="String">"</span>, <span class="ID">SMCDIR</span>, <span class="ID">FANS</span>[<span class="ID">i</span>]);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_110"> 110</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_110"></span><span class="anchor" id="line-110-1"></span>        <span class="ID">nanosleep</span>(&amp;<span class="ID">smc_write_delay</span>, <span class="ResWord">NULL</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_111"> 111</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_111"></span><span class="anchor" id="line-111-1"></span>        <span class="ResWord">if</span> ((<span class="ID">file</span>=<span class="ID">fopen</span>(<span class="ID">fan_path</span>, <span class="String">"</span><span class="String">w</span><span class="String">"</span>)) != <span class="ResWord">NULL</span>) {</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_112"> 112</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_112"></span><span class="anchor" id="line-112-1"></span>            <span class="ID">fprintf</span>(<span class="ID">file</span>, <span class="String">"</span><span class="String">%d</span><span class="String">"</span>, <span class="ID">speed</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_113"> 113</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_113"></span><span class="anchor" id="line-113-1"></span>            <span class="ID">fclose</span>(<span class="ID">file</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_114"> 114</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_114"></span><span class="anchor" id="line-114-1"></span>        }</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_115"> 115</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_115"></span><span class="anchor" id="line-115-1"></span>        <span class="ResWord">else</span> {</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_116"> 116</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_116"></span><span class="anchor" id="line-116-1"></span>            <span class="ID">syslog</span>(<span class="ID">LOG_WARNING</span>, <span class="String">"</span><span class="String">Error writing to %s, check if applesmc module loaded</span><span class="String">"</span>, <span class="ID">fan_path</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_117"> 117</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_117"></span><span class="anchor" id="line-117-1"></span>        }</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_118"> 118</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_118"></span><span class="anchor" id="line-118-1"></span>    }</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_119"> 119</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_119"></span><span class="anchor" id="line-119-1"></span>}</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_120"> 120</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_120"></span><span class="anchor" id="line-120-1"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_121"> 121</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_121"></span><span class="anchor" id="line-121-1"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_122"> 122</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_122"></span><span class="anchor" id="line-122-1"></span><span class="Comment">/* write value to fanX_manual */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_123"> 123</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_123"></span><span class="anchor" id="line-123-1"></span><span class="ResWord">static</span> <span class="ResWord">void</span> <span class="ID">set_fans_manual</span>(<span class="ResWord">int</span> <span class="ID">value</span>)</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_124"> 124</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_124"></span><span class="anchor" id="line-124-1"></span>{</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_125"> 125</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_125"></span><span class="anchor" id="line-125-1"></span>    <span class="ResWord">int</span> <span class="ID">i</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_126"> 126</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_126"></span><span class="anchor" id="line-126-1"></span>    <span class="ResWord">FILE</span> *<span class="ID">file</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_127"> 127</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_127"></span><span class="anchor" id="line-127-1"></span>    <span class="ResWord">char</span> <span class="ID">fan_path</span>[<span class="ID">SYSFS_PATH_MAX</span>];</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_128"> 128</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_128"></span><span class="anchor" id="line-128-1"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_129"> 129</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_129"></span><span class="anchor" id="line-129-1"></span>    <span class="Comment">/* for fans under control write value to fanX_manual */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_130"> 130</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_130"></span><span class="anchor" id="line-130-1"></span>    <span class="ResWord">for</span>(<span class="ID">i</span>=<span class="Number">0</span>; <span class="ID">i</span> &lt; <span class="ID">FANS_NUM</span>; <span class="ID">i</span>++ )</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_131"> 131</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_131"></span><span class="anchor" id="line-131-1"></span>    {</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_132"> 132</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_132"></span><span class="anchor" id="line-132-1"></span>        <span class="ID">sprintf</span>(<span class="ID">fan_path</span>, <span class="String">"</span><span class="String">%s/fan%d_manual</span><span class="String">"</span>, <span class="ID">SMCDIR</span>, <span class="ID">FANS</span>[<span class="ID">i</span>]);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_133"> 133</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_133"></span><span class="anchor" id="line-133-1"></span>        <span class="ID">nanosleep</span>(&amp;<span class="ID">smc_write_delay</span>, <span class="ResWord">NULL</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_134"> 134</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_134"></span><span class="anchor" id="line-134-1"></span>        <span class="ResWord">if</span> ((<span class="ID">file</span>=<span class="ID">fopen</span>(<span class="ID">fan_path</span>, <span class="String">"</span><span class="String">w</span><span class="String">"</span>)) != <span class="ResWord">NULL</span>) {</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_135"> 135</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_135"></span><span class="anchor" id="line-135-1"></span>            <span class="ID">fprintf</span>(<span class="ID">file</span>, <span class="String">"</span><span class="String">%d</span><span class="String">"</span>, <span class="ID">value</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_136"> 136</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_136"></span><span class="anchor" id="line-136-1"></span>            <span class="ID">fclose</span>(<span class="ID">file</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_137"> 137</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_137"></span><span class="anchor" id="line-137-1"></span>        }</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_138"> 138</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_138"></span><span class="anchor" id="line-138-1"></span>        <span class="ResWord">else</span> {</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_139"> 139</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_139"></span><span class="anchor" id="line-139-1"></span>            <span class="ID">syslog</span>(<span class="ID">LOG_WARNING</span>, <span class="String">"</span><span class="String">Error writing to %s, check if applesmc module loaded</span><span class="String">"</span>, <span class="ID">fan_path</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_140"> 140</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_140"></span><span class="anchor" id="line-140-1"></span>        }</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_141"> 141</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_141"></span><span class="anchor" id="line-141-1"></span>    }</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_142"> 142</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_142"></span><span class="anchor" id="line-142-1"></span>}</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_143"> 143</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_143"></span><span class="anchor" id="line-143-1"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_144"> 144</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_144"></span><span class="anchor" id="line-144-1"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_145"> 145</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_145"></span><span class="anchor" id="line-145-1"></span><span class="Comment">/* sort function for qsort: integers descending order */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_146"> 146</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_146"></span><span class="anchor" id="line-146-1"></span><span class="ResWord">static</span> <span class="ResWord">int</span> <span class="ID">compare_int_desc</span>(<span class="ResWord">const</span> <span class="ResWord">void</span> *<span class="ID">a</span>, <span class="ResWord">const</span> <span class="ResWord">void</span> *<span class="ID">b</span>) {</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_147"> 147</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_147"></span><span class="anchor" id="line-147-1"></span>    <span class="ResWord">int</span> *<span class="ID">da</span>, *<span class="ID">db</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_148"> 148</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_148"></span><span class="anchor" id="line-148-1"></span>    <span class="ID">da</span> = (<span class="ResWord">int</span> *)<span class="ID">a</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_149"> 149</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_149"></span><span class="anchor" id="line-149-1"></span>    <span class="ID">db</span> = (<span class="ResWord">int</span> *)<span class="ID">b</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_150"> 150</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_150"></span><span class="anchor" id="line-150-1"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_151"> 151</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_151"></span><span class="anchor" id="line-151-1"></span>    <span class="ResWord">return</span> *<span class="ID">db</span> - *<span class="ID">da</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_152"> 152</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_152"></span><span class="anchor" id="line-152-1"></span>}</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_153"> 153</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_153"></span><span class="anchor" id="line-153-1"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_154"> 154</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_154"></span><span class="anchor" id="line-154-1"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_155"> 155</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_155"></span><span class="anchor" id="line-155-1"></span><span class="Comment">/* return average of two largest temperatures, degrees  */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_156"> 156</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_156"></span><span class="anchor" id="line-156-1"></span><span class="ResWord">static</span> <span class="ResWord">int</span> <span class="ID">get_sensors_temp</span>(<span class="ResWord">void</span>)</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_157"> 157</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_157"></span><span class="anchor" id="line-157-1"></span>{</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_158"> 158</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_158"></span><span class="anchor" id="line-158-1"></span>    <span class="ResWord">int</span> <span class="ID">i</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_159"> 159</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_159"></span><span class="anchor" id="line-159-1"></span>    <span class="ResWord">int</span> <span class="ID">t</span>[<span class="ID">SENSORS_NUM</span>];</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_160"> 160</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_160"></span><span class="anchor" id="line-160-1"></span>    <span class="ResWord">char</span> <span class="ID">sensor_path</span>[<span class="ID">SYSFS_PATH_MAX</span>];</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_161"> 161</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_161"></span><span class="anchor" id="line-161-1"></span>    <span class="ResWord">FILE</span> *<span class="ID">file</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_162"> 162</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_162"></span><span class="anchor" id="line-162-1"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_163"> 163</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_163"></span><span class="anchor" id="line-163-1"></span>    <span class="Comment">/* for all sensors read temp1_input */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_164"> 164</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_164"></span><span class="anchor" id="line-164-1"></span>    <span class="ResWord">for</span>(<span class="ID">i</span>=<span class="Number">0</span>; <span class="ID">i</span> &lt; <span class="ID">SENSORS_NUM</span>; <span class="ID">i</span>++ )</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_165"> 165</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_165"></span><span class="anchor" id="line-165-1"></span>    {</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_166"> 166</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_166"></span><span class="anchor" id="line-166-1"></span>        <span class="ID">sprintf</span>(<span class="ID">sensor_path</span>, <span class="String">"</span><span class="String">%s.%d/temp1_input</span><span class="String">"</span>, <span class="ID">CORETEMP_PREFIX</span>, <span class="ID">SENSORS</span>[<span class="ID">i</span>]);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_167"> 167</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_167"></span><span class="anchor" id="line-167-1"></span>        <span class="ResWord">if</span> ((<span class="ID">file</span>=<span class="ID">fopen</span>(<span class="ID">sensor_path</span>, <span class="String">"</span><span class="String">r</span><span class="String">"</span>)) != <span class="ResWord">NULL</span>) {</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_168"> 168</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_168"></span><span class="anchor" id="line-168-1"></span>            <span class="ID">fscanf</span>(<span class="ID">file</span>, <span class="String">"</span><span class="String">%d</span><span class="String">"</span>, &amp;(<span class="ID">t</span>[<span class="ID">i</span>])); <span class="Comment">/* read temperature in millidegrees */</span> </span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_169"> 169</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_169"></span><span class="anchor" id="line-169-1"></span>            <span class="ID">fclose</span>(<span class="ID">file</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_170"> 170</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_170"></span><span class="anchor" id="line-170-1"></span>        }</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_171"> 171</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_171"></span><span class="anchor" id="line-171-1"></span>        <span class="ResWord">else</span> {</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_172"> 172</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_172"></span><span class="anchor" id="line-172-1"></span>            <span class="ID">syslog</span>(<span class="ID">LOG_ERR</span>, <span class="String">"</span><span class="String">Error reading %s, check if coretemp module loaded and number of sensors</span><span class="String">"</span>, <span class="ID">sensor_path</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_173"> 173</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_173"></span><span class="anchor" id="line-173-1"></span>            <span class="ID">clean_exit_with_status</span>(<span class="ID">EXIT_FAILURE</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_174"> 174</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_174"></span><span class="anchor" id="line-174-1"></span>        }</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_175"> 175</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_175"></span><span class="anchor" id="line-175-1"></span>    }</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_176"> 176</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_176"></span><span class="anchor" id="line-176-1"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_177"> 177</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_177"></span><span class="anchor" id="line-177-1"></span>    <span class="Comment">/* sort temperature values, descending order */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_178"> 178</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_178"></span><span class="anchor" id="line-178-1"></span>    <span class="ID">qsort</span>(<span class="ID">t</span>, <span class="ID">SENSORS_NUM</span>, <span class="ResWord">sizeof</span>(<span class="ID">t</span>[<span class="Number">0</span>]), <span class="ID">compare_int_desc</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_179"> 179</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_179"></span><span class="anchor" id="line-179-1"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_180"> 180</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_180"></span><span class="anchor" id="line-180-1"></span>    <span class="Comment">/* calculate average of two largest temps (if have more than one sensor) */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_181"> 181</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_181"></span><span class="anchor" id="line-181-1"></span>    <span class="ResWord">int</span> <span class="ID">avg</span> = <span class="Number">0</span>, <span class="ID">cnt</span> = <span class="Number">0</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_182"> 182</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_182"></span><span class="anchor" id="line-182-1"></span>    <span class="ResWord">for</span>(<span class="ID">i</span>=<span class="Number">0</span>; (<span class="ID">i</span> &lt; <span class="Number">2</span>) &amp;&amp; (<span class="ID">i</span> &lt; <span class="ID">SENSORS_NUM</span>); <span class="ID">i</span>++) {</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_183"> 183</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_183"></span><span class="anchor" id="line-183-1"></span>        <span class="ID">avg</span> += <span class="ID">t</span>[<span class="ID">i</span>];</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_184"> 184</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_184"></span><span class="anchor" id="line-184-1"></span>        <span class="ID">cnt</span> ++;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_185"> 185</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_185"></span><span class="anchor" id="line-185-1"></span>    }</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_186"> 186</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_186"></span><span class="anchor" id="line-186-1"></span>    <span class="ID">avg</span> = <span class="ID">avg</span>/<span class="ID">cnt</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_187"> 187</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_187"></span><span class="anchor" id="line-187-1"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_188"> 188</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_188"></span><span class="anchor" id="line-188-1"></span>    <span class="Comment">/* return temperature in degrees */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_189"> 189</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_189"></span><span class="anchor" id="line-189-1"></span>    <span class="ResWord">return</span> <span class="ID">avg</span>/<span class="Number">1000</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_190"> 190</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_190"></span><span class="anchor" id="line-190-1"></span>}</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_191"> 191</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_191"></span><span class="anchor" id="line-191-1"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_192"> 192</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_192"></span><span class="anchor" id="line-192-1"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_193"> 193</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_193"></span><span class="anchor" id="line-193-1"></span><span class="Comment">/* lock entire file */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_194"> 194</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_194"></span><span class="anchor" id="line-194-1"></span><span class="ResWord">static</span> <span class="ResWord">int</span> <span class="ID">lock_fd</span>(<span class="ResWord">int</span> <span class="ID">fd</span>)</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_195"> 195</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_195"></span><span class="anchor" id="line-195-1"></span>{</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_196"> 196</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_196"></span><span class="anchor" id="line-196-1"></span>    <span class="ResWord">struct</span> <span class="ID">flock</span> <span class="ID">lock</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_197"> 197</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_197"></span><span class="anchor" id="line-197-1"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_198"> 198</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_198"></span><span class="anchor" id="line-198-1"></span>    <span class="ID">lock</span>.<span class="ID">l_type</span> = <span class="ID">F_WRLCK</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_199"> 199</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_199"></span><span class="anchor" id="line-199-1"></span>    <span class="ID">lock</span>.<span class="ID">l_start</span> = <span class="Number">0</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_200"> 200</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_200"></span><span class="anchor" id="line-200-1"></span>    <span class="ID">lock</span>.<span class="ID">l_whence</span> = <span class="ID">SEEK_SET</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_201"> 201</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_201"></span><span class="anchor" id="line-201-1"></span>    <span class="ID">lock</span>.<span class="ID">l_len</span> = <span class="Number">0</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_202"> 202</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_202"></span><span class="anchor" id="line-202-1"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_203"> 203</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_203"></span><span class="anchor" id="line-203-1"></span>    <span class="ResWord">return</span> <span class="ID">fcntl</span>(<span class="ID">fd</span>, <span class="ID">F_SETLK</span>, &amp;<span class="ID">lock</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_204"> 204</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_204"></span><span class="anchor" id="line-204-1"></span>}</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_205"> 205</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_205"></span><span class="anchor" id="line-205-1"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_206"> 206</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_206"></span><span class="anchor" id="line-206-1"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_207"> 207</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_207"></span><span class="anchor" id="line-207-1"></span><span class="Comment">/* creates and locks pidfile */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_208"> 208</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_208"></span><span class="anchor" id="line-208-1"></span><span class="ResWord">static</span> <span class="ResWord">void</span> <span class="ID">create_pidfile</span>(<span class="ResWord">void</span>)</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_209"> 209</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_209"></span><span class="anchor" id="line-209-1"></span>{</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_210"> 210</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_210"></span><span class="anchor" id="line-210-1"></span>    <span class="ResWord">int</span> <span class="ID">fd</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_211"> 211</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_211"></span><span class="anchor" id="line-211-1"></span>    <span class="ResWord">FILE</span> *<span class="ID">f</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_212"> 212</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_212"></span><span class="anchor" id="line-212-1"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_213"> 213</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_213"></span><span class="anchor" id="line-213-1"></span>    <span class="Comment">/* open the pidfile */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_214"> 214</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_214"></span><span class="anchor" id="line-214-1"></span>    <span class="ID">fd</span> = <span class="ID">open</span>(<span class="ID">PIDFILE</span>, <span class="ID">O_RDWR</span>|<span class="ID">O_CREAT</span>, <span class="ID">S_IRUSR</span>|<span class="ID">S_IWUSR</span>|<span class="ID">S_IRGRP</span>|<span class="ID">S_IROTH</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_215"> 215</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_215"></span><span class="anchor" id="line-215-1"></span>    <span class="ResWord">if</span> (<span class="ID">fd</span> &lt; <span class="Number">0</span>) {</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_216"> 216</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_216"></span><span class="anchor" id="line-216-1"></span>        <span class="ID">syslog</span>(<span class="ID">LOG_ERR</span>, <span class="String">"</span><span class="String">can't open %s: %s</span><span class="SPChar">\n</span><span class="String">"</span>, <span class="ID">PIDFILE</span>, <span class="ID">strerror</span>(<span class="ID">errno</span>));</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_217"> 217</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_217"></span><span class="anchor" id="line-217-1"></span>        <span class="ID">exit</span>(<span class="ID">EXIT_FAILURE</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_218"> 218</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_218"></span><span class="anchor" id="line-218-1"></span>    }</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_219"> 219</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_219"></span><span class="anchor" id="line-219-1"></span>    <span class="Comment">/* lock pid file */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_220"> 220</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_220"></span><span class="anchor" id="line-220-1"></span>    <span class="ResWord">if</span> (<span class="ID">lock_fd</span>(<span class="ID">fd</span>) &lt; <span class="Number">0</span>) {</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_221"> 221</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_221"></span><span class="anchor" id="line-221-1"></span>        <span class="ResWord">if</span> (<span class="ID">errno</span> == <span class="ID">EACCES</span> || <span class="ID">errno</span> == <span class="ID">EAGAIN</span>) {</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_222"> 222</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_222"></span><span class="anchor" id="line-222-1"></span>            <span class="ID">syslog</span>(<span class="ID">LOG_ERR</span>, <span class="String">"</span><span class="String">daemon already running</span><span class="String">"</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_223"> 223</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_223"></span><span class="anchor" id="line-223-1"></span>        } <span class="ResWord">else</span> {</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_224"> 224</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_224"></span><span class="anchor" id="line-224-1"></span>            <span class="ID">syslog</span>(<span class="ID">LOG_ERR</span>, <span class="String">"</span><span class="String">can't lock %s: %s</span><span class="String">"</span>, <span class="ID">PIDFILE</span>, <span class="ID">strerror</span>(<span class="ID">errno</span>));</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_225"> 225</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_225"></span><span class="anchor" id="line-225-1"></span>        }</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_226"> 226</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_226"></span><span class="anchor" id="line-226-1"></span>        <span class="ID">exit</span>(<span class="ID">EXIT_FAILURE</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_227"> 227</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_227"></span><span class="anchor" id="line-227-1"></span>    }</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_228"> 228</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_228"></span><span class="anchor" id="line-228-1"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_229"> 229</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_229"></span><span class="anchor" id="line-229-1"></span>    <span class="Comment">/* write pid */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_230"> 230</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_230"></span><span class="anchor" id="line-230-1"></span>    <span class="ID">ftruncate</span>(<span class="ID">fd</span>, <span class="Number">0</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_231"> 231</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_231"></span><span class="anchor" id="line-231-1"></span>    <span class="ID">f</span> = <span class="ID">fdopen</span>(<span class="ID">fd</span>, <span class="String">"</span><span class="String">w</span><span class="String">"</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_232"> 232</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_232"></span><span class="anchor" id="line-232-1"></span>    <span class="ID">fprintf</span>(<span class="ID">f</span>, <span class="String">"</span><span class="String">%d</span><span class="SPChar">\n</span><span class="String">"</span>, <span class="ID">getpid</span>());</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_233"> 233</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_233"></span><span class="anchor" id="line-233-1"></span>    <span class="ID">fflush</span>(<span class="ID">f</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_234"> 234</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_234"></span><span class="anchor" id="line-234-1"></span>    <span class="Comment">/* keep file open and locked */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_235"> 235</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_235"></span><span class="anchor" id="line-235-1"></span>}</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_236"> 236</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_236"></span><span class="anchor" id="line-236-1"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_237"> 237</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_237"></span><span class="anchor" id="line-237"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_238"> 238</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_238"></span><span class="anchor" id="line-238"></span><span class="Comment">/* become a daemon and open log */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_239"> 239</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_239"></span><span class="anchor" id="line-239"></span><span class="ResWord">void</span> <span class="ID">daemonize</span>(<span class="ResWord">void</span>)</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_240"> 240</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_240"></span><span class="anchor" id="line-240"></span>{</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_241"> 241</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_241"></span><span class="anchor" id="line-241"></span>    <span class="ResWord">int</span> <span class="ID">i</span>, <span class="ID">maxfd</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_242"> 242</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_242"></span><span class="anchor" id="line-242"></span>    <span class="ResWord">int</span> <span class="ID">fd0</span>, <span class="ID">fd1</span>, <span class="ID">fd2</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_243"> 243</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_243"></span><span class="anchor" id="line-243"></span>    <span class="ResWord">pid_t</span> <span class="ID">pid</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_244"> 244</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_244"></span><span class="anchor" id="line-244"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_245"> 245</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_245"></span><span class="anchor" id="line-245"></span>    <span class="Comment">/* clear file creation mask */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_246"> 246</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_246"></span><span class="anchor" id="line-246"></span>    <span class="ID">umask</span>(<span class="Number">0</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_247"> 247</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_247"></span><span class="anchor" id="line-247"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_248"> 248</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_248"></span><span class="anchor" id="line-248"></span>    <span class="Comment">/* fork and become a session leader */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_249"> 249</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_249"></span><span class="anchor" id="line-249"></span>    <span class="ResWord">if</span> ((<span class="ID">pid</span>=<span class="ID">fork</span>()) &lt; <span class="Number">0</span>) { </span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_250"> 250</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_250"></span><span class="anchor" id="line-250"></span>        <span class="ID">fprintf</span>(<span class="ID">stderr</span>, <span class="String">"</span><span class="String">fork failed</span><span class="SPChar">\n</span><span class="String">"</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_251"> 251</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_251"></span><span class="anchor" id="line-251"></span>        <span class="ID">exit</span>(<span class="ID">EXIT_FAILURE</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_252"> 252</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_252"></span><span class="anchor" id="line-252"></span>    }</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_253"> 253</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_253"></span><span class="anchor" id="line-253"></span>    <span class="ResWord">else</span> <span class="ResWord">if</span> (<span class="ID">pid</span> != <span class="Number">0</span>) { <span class="Comment">/* parent */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_254"> 254</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_254"></span><span class="anchor" id="line-254"></span>        <span class="ID">exit</span>(<span class="ID">EXIT_SUCCESS</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_255"> 255</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_255"></span><span class="anchor" id="line-255"></span>    }</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_256"> 256</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_256"></span><span class="anchor" id="line-256"></span>    <span class="ID">setsid</span>();</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_257"> 257</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_257"></span><span class="anchor" id="line-257"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_258"> 258</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_258"></span><span class="anchor" id="line-258"></span>    <span class="Comment">/* change current working directory to the root */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_259"> 259</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_259"></span><span class="anchor" id="line-259"></span>    <span class="ResWord">if</span> (<span class="ID">chdir</span>(<span class="String">"</span><span class="String">/</span><span class="String">"</span>) &lt; <span class="Number">0</span>) {</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_260"> 260</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_260"></span><span class="anchor" id="line-260"></span>        <span class="ID">fprintf</span>(<span class="ID">stderr</span>, <span class="String">"</span><span class="String">can't change directory to /</span><span class="String">"</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_261"> 261</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_261"></span><span class="anchor" id="line-261"></span>        <span class="ID">exit</span>(<span class="ID">EXIT_FAILURE</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_262"> 262</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_262"></span><span class="anchor" id="line-262"></span>    }</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_263"> 263</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_263"></span><span class="anchor" id="line-263"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_264"> 264</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_264"></span><span class="anchor" id="line-264"></span>    <span class="Comment">/* close all open file descriptors */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_265"> 265</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_265"></span><span class="anchor" id="line-265"></span>    <span class="ID">maxfd</span> = <span class="ID">sysconf</span>(<span class="ID">_SC_OPEN_MAX</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_266"> 266</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_266"></span><span class="anchor" id="line-266"></span>    <span class="ResWord">for</span> (<span class="ID">i</span>=<span class="Number">0</span>; <span class="ID">i</span> &lt; <span class="ID">maxfd</span>; <span class="ID">i</span>++)</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_267"> 267</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_267"></span><span class="anchor" id="line-267"></span>        <span class="ID">close</span>(<span class="ID">i</span>); </span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_268"> 268</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_268"></span><span class="anchor" id="line-268"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_269"> 269</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_269"></span><span class="anchor" id="line-269"></span>    <span class="Comment">/* set up stdin, stdout, stderr to /dev/null */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_270"> 270</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_270"></span><span class="anchor" id="line-270"></span>    <span class="ID">fd0</span> = <span class="ID">open</span>(<span class="String">"</span><span class="String">/dev/null</span><span class="String">"</span>, <span class="ID">O_RDWR</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_271"> 271</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_271"></span><span class="anchor" id="line-271"></span>    <span class="ID">fd1</span> = <span class="ID">dup</span>(<span class="ID">fd0</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_272"> 272</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_272"></span><span class="anchor" id="line-272"></span>    <span class="ID">fd2</span> = <span class="ID">dup</span>(<span class="ID">fd0</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_273"> 273</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_273"></span><span class="anchor" id="line-273"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_274"> 274</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_274"></span><span class="anchor" id="line-274"></span>    <span class="Comment">/* open log */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_275"> 275</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_275"></span><span class="anchor" id="line-275"></span>    <span class="ID">openlog</span>(<span class="String">"</span><span class="String">smcfancontrol</span><span class="String">"</span>, <span class="ID">LOG_PID</span>, <span class="ID">LOG_DAEMON</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_276"> 276</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_276"></span><span class="anchor" id="line-276"></span>    <span class="ResWord">if</span> (<span class="ID">fd0</span> != <span class="ID">STDIN_FILENO</span> || <span class="ID">fd1</span> != <span class="ID">STDOUT_FILENO</span> || <span class="ID">fd2</span> != <span class="ID">STDERR_FILENO</span>) {</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_277"> 277</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_277"></span><span class="anchor" id="line-277"></span>        <span class="ID">syslog</span>(<span class="ID">LOG_ERR</span>, <span class="String">"</span><span class="String">unexpected file descriptors %d %d %d</span><span class="String">"</span>, <span class="ID">fd0</span>, <span class="ID">fd1</span>, <span class="ID">fd2</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_278"> 278</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_278"></span><span class="anchor" id="line-278"></span>        <span class="ID">exit</span>(<span class="ID">EXIT_FAILURE</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_279"> 279</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_279"></span><span class="anchor" id="line-279"></span>    }</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_280"> 280</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_280"></span><span class="anchor" id="line-280"></span>}</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_281"> 281</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_281"></span><span class="anchor" id="line-281"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_282"> 282</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_282"></span><span class="anchor" id="line-282"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_283"> 283</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_283"></span><span class="anchor" id="line-283"></span><span class="ResWord">int</span> <span class="ID">main</span>(<span class="ResWord">int</span> <span class="ID">argc</span>, <span class="ResWord">char</span> *<span class="ID">argv</span>[])</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_284"> 284</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_284"></span><span class="anchor" id="line-284"></span>{</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_285"> 285</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_285"></span><span class="anchor" id="line-285"></span>    <span class="ResWord">struct</span> <span class="ID">timespec</span> <span class="ID">sleep_period</span>;   <span class="Comment">/* delay between sensor polls */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_286"> 286</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_286"></span><span class="anchor" id="line-286"></span>    <span class="ResWord">int</span> <span class="ID">t</span>, <span class="ID">t_old</span>;                   <span class="Comment">/* current and previous temperature */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_287"> 287</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_287"></span><span class="anchor" id="line-287"></span>    <span class="ResWord">int</span> <span class="ID">speed_step</span>, <span class="ID">old_speed_step</span>; <span class="Comment">/* current and old speed step */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_288"> 288</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_288"></span><span class="anchor" id="line-288"></span>    <span class="ResWord">int</span> <span class="ID">cold</span>, <span class="ID">hot</span>;                  <span class="Comment">/* number of consecutive temperature (de/in)creases */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_289"> 289</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_289"></span><span class="anchor" id="line-289"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_290"> 290</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_290"></span><span class="anchor" id="line-290"></span>    <span class="Comment">/* become a daemon */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_291"> 291</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_291"></span><span class="anchor" id="line-291"></span>    <span class="ID">daemonize</span>();</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_292"> 292</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_292"></span><span class="anchor" id="line-292"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_293"> 293</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_293"></span><span class="anchor" id="line-293"></span>    <span class="ID">syslog</span>(<span class="ID">LOG_INFO</span>, <span class="String">"</span><span class="String">starting up</span><span class="SPChar">\n</span><span class="String">"</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_294"> 294</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_294"></span><span class="anchor" id="line-294"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_295"> 295</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_295"></span><span class="anchor" id="line-295"></span>    <span class="Comment">/* trap key signals */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_296"> 296</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_296"></span><span class="anchor" id="line-296"></span>    <span class="ID">signal</span>(<span class="ID">SIGTERM</span>, <span class="ID">clean_exit</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_297"> 297</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_297"></span><span class="anchor" id="line-297"></span>    <span class="ID">signal</span>(<span class="ID">SIGQUIT</span>, <span class="ID">clean_exit</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_298"> 298</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_298"></span><span class="anchor" id="line-298"></span>    <span class="ID">signal</span>(<span class="ID">SIGINT</span>,  <span class="ID">clean_exit</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_299"> 299</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_299"></span><span class="anchor" id="line-299"></span>    <span class="ID">signal</span>(<span class="ID">SIGHUP</span>,  <span class="ID">SIG_IGN</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_300"> 300</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_300"></span><span class="anchor" id="line-300"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_301"> 301</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_301"></span><span class="anchor" id="line-301"></span>    <span class="Comment">/* create pidfile and lock it */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_302"> 302</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_302"></span><span class="anchor" id="line-302"></span>    <span class="ID">create_pidfile</span>();</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_303"> 303</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_303"></span><span class="anchor" id="line-303"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_304"> 304</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_304"></span><span class="anchor" id="line-304"></span>    <span class="Comment">/* set fans to automatic control */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_305"> 305</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_305"></span><span class="anchor" id="line-305"></span>    <span class="ID">set_fans_manual</span>(<span class="Number">0</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_306"> 306</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_306"></span><span class="anchor" id="line-306"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_307"> 307</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_307"></span><span class="anchor" id="line-307"></span>    <span class="Comment">/* initial temperatures */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_308"> 308</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_308"></span><span class="anchor" id="line-308"></span>    <span class="ID">t</span> = <span class="ID">t_old</span> = <span class="ID">get_sensors_temp</span>();</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_309"> 309</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_309"></span><span class="anchor" id="line-309"></span>    <span class="ID">cold</span> = <span class="ID">hot</span> = <span class="Number">1</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_310"> 310</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_310"></span><span class="anchor" id="line-310"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_311"> 311</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_311"></span><span class="anchor" id="line-311"></span>    <span class="Comment">/* init speed step and set fans */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_312"> 312</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_312"></span><span class="anchor" id="line-312"></span>    <span class="ID">speed_step</span> = <span class="ID">temperature_to_speed_step</span>(<span class="ID">t</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_313"> 313</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_313"></span><span class="anchor" id="line-313"></span>    <span class="ID">set_fans_min</span>(<span class="ID">speed_step</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_314"> 314</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_314"></span><span class="anchor" id="line-314"></span>    <span class="ID">old_speed_step</span> = <span class="ID">speed_step</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_315"> 315</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_315"></span><span class="anchor" id="line-315"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_316"> 316</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_316"></span><span class="anchor" id="line-316"></span>    <span class="Comment">/* set sleep timer to 0.5 sec */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_317"> 317</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_317"></span><span class="anchor" id="line-317"></span>    <span class="ID">sleep_period</span>.<span class="ID">tv_sec</span> = <span class="Number">0</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_318"> 318</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_318"></span><span class="anchor" id="line-318"></span>    <span class="ID">sleep_period</span>.<span class="ID">tv_nsec</span> = <span class="Number">500000000</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_319"> 319</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_319"></span><span class="anchor" id="line-319"></span>    </span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_320"> 320</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_320"></span><span class="anchor" id="line-320"></span>    <span class="Comment">/* main loop */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_321"> 321</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_321"></span><span class="anchor" id="line-321"></span>    <span class="ResWord">while</span>(<span class="Number">1</span>)</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_322"> 322</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_322"></span><span class="anchor" id="line-322"></span>    {</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_323"> 323</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_323"></span><span class="anchor" id="line-323"></span>        <span class="ID">t</span> = <span class="ID">get_sensors_temp</span>();</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_324"> 324</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_324"></span><span class="anchor" id="line-324"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_325"> 325</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_325"></span><span class="anchor" id="line-325"></span>        <span class="ResWord">if</span> ( <span class="ID">t</span> &lt; <span class="ID">t_old</span> ) { <span class="Comment">/* it's getting colder */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_326"> 326</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_326"></span><span class="anchor" id="line-326"></span>            <span class="ID">cold</span>++;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_327"> 327</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_327"></span><span class="anchor" id="line-327"></span>            <span class="ID">hot</span> = <span class="Number">0</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_328"> 328</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_328"></span><span class="anchor" id="line-328"></span>        }</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_329"> 329</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_329"></span><span class="anchor" id="line-329"></span>        <span class="ResWord">if</span> ( <span class="ID">t</span> &gt; <span class="ID">t_old</span> ) { <span class="Comment">/* it's getting hotter */</span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_330"> 330</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_330"></span><span class="anchor" id="line-330"></span>            <span class="ID">hot</span>++;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_331"> 331</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_331"></span><span class="anchor" id="line-331"></span>            <span class="ID">cold</span> = <span class="Number">0</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_332"> 332</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_332"></span><span class="anchor" id="line-332"></span>        }</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_333"> 333</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_333"></span><span class="anchor" id="line-333"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_334"> 334</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_334"></span><span class="anchor" id="line-334"></span>        <span class="ResWord">if</span> ( (<span class="ID">cold</span>==<span class="Number">2</span>) || (<span class="ID">hot</span>==<span class="Number">2</span>) ) </span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_335"> 335</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_335"></span><span class="anchor" id="line-335"></span>        {</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_336"> 336</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_336"></span><span class="anchor" id="line-336"></span>            <span class="ID">speed_step</span> = <span class="ID">temperature_to_speed_step</span>(<span class="ID">t</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_337"> 337</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_337"></span><span class="anchor" id="line-337"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_338"> 338</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_338"></span><span class="anchor" id="line-338"></span>            <span class="ResWord">if</span> ( <span class="ID">speed_step</span> != <span class="ID">old_speed_step</span>) {</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_339"> 339</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_339"></span><span class="anchor" id="line-339"></span>                <span class="ID">set_fans_min</span>(<span class="ID">speed_step</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_340"> 340</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_340"></span><span class="anchor" id="line-340"></span>                <span class="ID">syslog</span>(<span class="ID">LOG_INFO</span>, <span class="String">"</span><span class="String">changed to speed step %d (of %d) at temperature %d</span><span class="String">"</span>, <span class="ID">speed_step</span>, <span class="ID">SPEED_STEP_MAX</span>, <span class="ID">t</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_341"> 341</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_341"></span><span class="anchor" id="line-341"></span>                <span class="ID">old_speed_step</span> = <span class="ID">speed_step</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_342"> 342</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_342"></span><span class="anchor" id="line-342"></span>            }</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_343"> 343</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_343"></span><span class="anchor" id="line-343"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_344"> 344</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_344"></span><span class="anchor" id="line-344"></span>            <span class="ID">cold</span> = <span class="Number">0</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_345"> 345</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_345"></span><span class="anchor" id="line-345"></span>            <span class="ID">hot</span> = <span class="Number">0</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_346"> 346</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_346"></span><span class="anchor" id="line-346"></span>        }</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_347"> 347</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_347"></span><span class="anchor" id="line-347"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_348"> 348</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_348"></span><span class="anchor" id="line-348"></span>        <span class="ResWord">if</span>( <span class="ID">nanosleep</span>(&amp;<span class="ID">sleep_period</span>, <span class="ResWord">NULL</span>) &lt; <span class="Number">0</span> &amp;&amp; <span class="ID">errno</span> != <span class="ID">EINTR</span> )</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_349"> 349</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_349"></span><span class="anchor" id="line-349"></span>        {</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_350"> 350</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_350"></span><span class="anchor" id="line-350"></span>            <span class="ID">clean_exit_with_status</span>(<span class="ID">EXIT_FAILURE</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_351"> 351</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_351"></span><span class="anchor" id="line-351"></span>        }</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_352"> 352</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_352"></span><span class="anchor" id="line-352"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_353"> 353</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_353"></span><span class="anchor" id="line-353"></span>        <span class="ID">t_old</span> = <span class="ID">t</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_354"> 354</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_354"></span><span class="anchor" id="line-354"></span>    }</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_355"> 355</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_355"></span><span class="anchor" id="line-355"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_356"> 356</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_356"></span><span class="anchor" id="line-356"></span>    <span class="ID">clean_exit_with_status</span>(<span class="ID">EXIT_SUCCESS</span>);</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_357"> 357</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_357"></span><span class="anchor" id="line-357"></span></span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_358"> 358</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_358"></span><span class="anchor" id="line-358"></span>    <span class="ResWord">return</span> <span class="Number">0</span>;</span>
<span class="line"><span class="LineNumber"><a href="#CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_359"> 359</a> </span><span class="LineAnchor" id="CA-11e5e47a1c81acff09aeb867c20d7555f0e3f3e7_359"></span><span class="anchor" id="line-359"></span>}</span>
</pre></div></div><a class="attachment" href="https://wiki.debian.org/DebianOnIntelMacPro?action=AttachFile&amp;do=view&amp;target=smcfancontrol.c" title="attachment:smcfancontrol.c">smcfancontrol.c</a> <span class="anchor" id="line-237-1"></span><object data="DebianOnIntelMacPro%20-%20Debian%20Wiki_files/DebianOnIntelMacPro" title="" type="application/x-sh">smcfancontrol.sh</object> <span class="anchor" id="line-238-1"></span><span class="anchor" id="line-239-1"></span><span class="anchor" id="line-240-1"></span><p class="line867"></p><hr><p class="line874"> <span class="anchor" id="line-241-1"></span></p><ul><li style="list-style-type:none"><p class="line891"><a href="https://wiki.debian.org/CategoryDesktopComputer">CategoryDesktopComputer</a> <span class="anchor" id="line-242-1"></span><a href="https://wiki.debian.org/CategoryMacintoshComputer">CategoryMacintoshComputer</a> <span class="anchor" id="line-243-1"></span></p></li></ul><span class="anchor" id="bottom"></span></div><div id="pagebottom"></div>
</div>


<div id="footer">
<p id="pageinfo" class="info" dir="ltr" lang="en">DebianOnIntelMacPro  (<a class="nbinfo" href="https://wiki.debian.org/DebianOnIntelMacPro?action=info" rel="nofollow">last modified 2010-04-30 04:54:47</a>)</p>

<ul id="credits">
<li><a href="https://moinmo.in/" title="This site uses the MoinMoin Wiki software.">MoinMoin Powered</a></li><li><a href="https://moinmo.in/Python" title="MoinMoin is written in Python.">Python Powered</a></li><li>Debian Wiki <a href="https://wiki.debian.org/Teams/DebianWiki">team</a>, <a href="https://bugs.debian.org/wiki.debian.org">bugs</a> and <a href="https://git.debian.org/?p=collab-maint/wiki.debian.org.git;a=summary">config</a> available.</li><li>Hosting provided by <a href="https://www.man-da.de/">Metropolitan Area Network Darmstadt</a></li>
</ul>


</div>



</body></html>